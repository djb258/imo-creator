name: CTB Drift Check

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop


jobs:
  verify:
    runs-on: ubuntu-latest
    name: Verify CTB Template Structure

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Verify CTB Template Structure
        run: |
          echo "ğŸ” Verifying CTB template structure..."

          if [ ! -f "ctb-template/version.json" ]; then
            echo "::warning::CTB version.json not found - not a CTB-scaffolded repo"
            exit 0
          fi

          echo "âœ… CTB template detected"

          CTB_VERSION=$(cat ctb-template/version.json | grep -o '"ctb_version"[[:space:]]*:[[:space:]]*"[^"]*"' | cut -d'"' -f4)
          echo "ğŸ“¦ CTB Version: $CTB_VERSION"

      - name: Verify Barton Policy
        run: |
          if [ -f "ctb-template/.barton_policy.json" ]; then
            echo "ğŸ” Validating Barton policy..."

            if ! grep -q '"requires_composio": true' ctb-template/.barton_policy.json; then
              echo "::error::Barton policy must require Composio"
              exit 1
            fi

            echo "âœ… Barton policy validation passed"
          else
            echo "::warning::Barton policy not found - skipping validation"
          fi

      - name: Drift Check Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… CTB Drift Check Complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
