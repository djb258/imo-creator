%% IMO Creator - System Architecture Diagram
%% Purpose: Visual representation of data ‚Üî AI ‚Üî UI flow
%% Last Updated: 2025-10-23

graph TB
    %% External Users
    User[üë§ User/Client<br/>Browser]

    %% Frontend Layer (UI)
    subgraph UI["üé® UI Layer (ctb/ui)"]
        ReactApp[React Application]
        Components[React Components]
        Forms[Forms & Validation]
        Dashboard[Dashboard]
    end

    %% API Layer (SYS)
    subgraph API["üîß API Layer (ctb/sys/api)"]
        FastAPI[FastAPI Server<br/>Port 8000]
        HEIRMiddleware[HEIR/ORBT<br/>Middleware]
        APIEndpoints[REST Endpoints]
    end

    %% AI Layer
    subgraph AI["ü§ñ AI Layer (ctb/ai)"]
        Orchestrator[Agent Orchestrator]
        IMOCreator[IMO Creator Agent]
        ComplianceAgent[Compliance Agent]
        GeminiModel[Google Gemini<br/>API]
    end

    %% Integration Layer (SYS)
    subgraph Integration["üîå Integration Layer (ctb/sys)"]
        ComposioMCP[Composio MCP Server<br/>Port 3001]
        Gmail[Gmail Integration]
        GitHub[GitHub Integration]
        Apify[Apify Integration]
        Instantly[Instantly.ai]
        Other[100+ Services]
    end

    %% Data Layer
    subgraph Data["üíæ Data Layer (ctb/data)"]
        DBClient[Database Client]
        Migrations[Migrations]
        Schemas[Schemas]
        Validation[Zod Validation]
    end

    %% Databases
    subgraph Databases["üóÑÔ∏è Databases"]
        Neon[(Neon PostgreSQL<br/>Primary DB)]
        Firebase[(Firebase/Firestore<br/>Workbench)]
        BigQuery[(BigQuery<br/>Analytics)]
    end

    %% Configuration (META)
    subgraph Config["‚öôÔ∏è Configuration (ctb/meta)"]
        Registry[CTB Registry]
        GlobalConfig[Global Config]
        EnvVars[Environment Variables]
    end

    %% User Interactions
    User -->|HTTP Requests| UI
    UI -->|Display| User

    %% UI to API
    ReactApp --> APIEndpoints
    Components --> APIEndpoints
    Forms --> APIEndpoints
    Dashboard --> APIEndpoints

    %% API to Middleware
    APIEndpoints --> HEIRMiddleware
    HEIRMiddleware --> FastAPI

    %% API to AI
    FastAPI -->|Trigger AI Workflows| Orchestrator
    Orchestrator -->|Route to Agents| IMOCreator
    Orchestrator -->|Route to Agents| ComplianceAgent
    IMOCreator -->|Generate Content| GeminiModel
    ComplianceAgent -->|Validate| GeminiModel

    %% API to Integrations
    FastAPI -->|External Services| ComposioMCP
    ComposioMCP --> Gmail
    ComposioMCP --> GitHub
    ComposioMCP --> Apify
    ComposioMCP --> Instantly
    ComposioMCP --> Other

    %% API to Data
    FastAPI -->|Query/Command| DBClient

    %% Data Layer Internals
    DBClient --> Migrations
    DBClient --> Schemas
    Forms --> Validation

    %% Data to Databases
    DBClient -->|Read/Write| Neon
    DBClient -->|Real-time| Firebase
    DBClient -->|Analytics| BigQuery

    %% AI to Data (Training)
    IMOCreator -.->|Read Training Data| Schemas
    ComplianceAgent -.->|Read Rules| Schemas

    %% UI to Data (Validation)
    Forms -.->|Validate with| Validation

    %% Configuration to All
    Config -.->|Configure| FastAPI
    Config -.->|Configure| DBClient
    Config -.->|Configure| ComposioMCP
    Config -.->|Configure| Orchestrator

    %% Return Flows
    GeminiModel -.->|AI Response| Orchestrator
    Orchestrator -.->|Results| FastAPI
    FastAPI -.->|JSON Response| APIEndpoints
    APIEndpoints -.->|Data| ReactApp
    DBClient -.->|Query Results| FastAPI

    %% Styling
    classDef uiClass fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef apiClass fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef aiClass fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef dataClass fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef dbClass fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    classDef configClass fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef integrationClass fill:#e0f2f1,stroke:#004d40,stroke-width:2px

    class UI,ReactApp,Components,Forms,Dashboard uiClass
    class API,FastAPI,HEIRMiddleware,APIEndpoints apiClass
    class AI,Orchestrator,IMOCreator,ComplianceAgent,GeminiModel aiClass
    class Data,DBClient,Migrations,Schemas,Validation dataClass
    class Databases,Neon,Firebase,BigQuery dbClass
    class Config,Registry,GlobalConfig,EnvVars configClass
    class Integration,ComposioMCP,Gmail,GitHub,Apify,Instantly,Other integrationClass
