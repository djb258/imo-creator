# ═══════════════════════════════════════════════════════════════════════════════
# REUSABLE CTB ENFORCEMENT
# ═══════════════════════════════════════════════════════════════════════════════
# Authority: imo-creator (Constitutional)
# Purpose: Reusable workflow for CTB doctrine enforcement (called by other workflows)
# Trigger: workflow_call only
# ═══════════════════════════════════════════════════════════════════════════════

name: Reusable CTB Enforcement

on:
  workflow_call:
    inputs:
      enforcement_mode:
        description: 'Enforcement mode (standard or strict)'
        required: false
        type: string
        default: 'standard'
    outputs:
      status:
        description: 'Enforcement status (PASSED or FAILED)'
        value: ${{ jobs.enforce.outputs.status }}

jobs:
  enforce:
    name: CTB Doctrine Enforcement
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.enforcement.outputs.status }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Make enforcement script executable
        run: |
          if [ -f "templates/scripts/ctb_enforce.sh" ]; then
            chmod +x templates/scripts/ctb_enforce.sh
          fi

      - name: Run CTB Enforcement
        id: enforcement
        run: |
          if [ -f "templates/scripts/ctb_enforce.sh" ]; then
            if bash templates/scripts/ctb_enforce.sh; then
              echo "status=PASSED" >> $GITHUB_OUTPUT
            else
              echo "::error::CTB enforcement script failed (exit $?)"
              echo "status=FAILED" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "::error::CTB enforcement script not found — FAIL (not skip). Doctrine: FAIL_CLOSED_CI_CONTRACT.md §2"
            echo "status=FAILED" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload enforcement log
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: ctb-enforcement-log
          path: logs/ctb_enforcement.log
          retention-days: 30

      - name: Enforcement summary
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "CTB Enforcement Complete"
          echo "Status: ${{ steps.enforcement.outputs.status }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
