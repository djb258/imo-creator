{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://ctb.barton-doctrine.dev/schemas/system_health_response.schema.json",
  "title": "CTB System Health Response",
  "description": "Schema for CTB system-wide health status API response",
  "type": "object",
  "required": [
    "version",
    "last_updated",
    "system_health",
    "roles",
    "alerts"
  ],
  "properties": {
    "version": {
      "type": "string",
      "description": "CTB version number (semantic versioning)",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "example": "1.3.0"
    },
    "last_updated": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of last status check",
      "example": "2025-10-23T12:34:56Z"
    },
    "scan_interval_ms": {
      "type": "integer",
      "description": "Recommended polling interval in milliseconds",
      "minimum": 1000,
      "example": 30000
    },
    "system_health": {
      "type": "object",
      "required": [
        "overall_status",
        "roles_healthy",
        "roles_degraded",
        "roles_down"
      ],
      "properties": {
        "overall_status": {
          "type": "string",
          "enum": ["healthy", "degraded", "critical"],
          "description": "Aggregate system health status"
        },
        "roles_healthy": {
          "type": "integer",
          "minimum": 0,
          "description": "Count of healthy/connected roles"
        },
        "roles_degraded": {
          "type": "integer",
          "minimum": 0,
          "description": "Count of degraded roles (high latency, partial failures)"
        },
        "roles_down": {
          "type": "integer",
          "minimum": 0,
          "description": "Count of disconnected/failed roles"
        },
        "last_incident": {
          "type": ["string", "null"],
          "format": "date-time",
          "description": "ISO 8601 timestamp of last critical incident, or null if none"
        }
      }
    },
    "roles": {
      "type": "object",
      "description": "Health diagnostics for each CTB role",
      "additionalProperties": {
        "$ref": "#/definitions/RoleDiagnostics"
      }
    },
    "alerts": {
      "type": "array",
      "description": "Active system alerts and warnings",
      "items": {
        "type": "string"
      }
    },
    "viewer_schema": {
      "type": "object",
      "description": "Metadata for CTB Viewer App integration",
      "properties": {
        "json_endpoint": {
          "type": "string",
          "description": "Path to system diagnostics JSON file"
        },
        "update_script": {
          "type": "string",
          "description": "Path to status check script"
        },
        "websocket_support": {
          "type": "boolean",
          "description": "Whether real-time websocket updates are supported"
        },
        "polling_recommended_ms": {
          "type": "integer",
          "description": "Recommended polling interval for HTTP requests"
        }
      }
    }
  },
  "definitions": {
    "RoleDiagnostics": {
      "type": "object",
      "required": [
        "status",
        "latency_ms",
        "driver",
        "health_endpoint",
        "last_check",
        "issues"
      ],
      "properties": {
        "status": {
          "type": "string",
          "enum": ["connected", "healthy", "degraded", "disconnected"],
          "description": "Current health status of the role"
        },
        "latency_ms": {
          "type": "number",
          "minimum": 0,
          "description": "Response latency in milliseconds"
        },
        "driver": {
          "type": "string",
          "description": "Current driver implementation (vendor-agnostic)",
          "examples": ["gemini", "firebase", "neon", "composio-mcp"]
        },
        "health_endpoint": {
          "type": "string",
          "description": "Health check endpoint URL or identifier"
        },
        "last_check": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of last health check"
        },
        "issues": {
          "type": "array",
          "description": "List of detected issues for this role",
          "items": {
            "type": "string"
          }
        }
      },
      "additionalProperties": true
    }
  }
}
