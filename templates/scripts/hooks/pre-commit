#!/bin/bash
# ═══════════════════════════════════════════════════════════════════════════════
# PRE-COMMIT HOOK — DOCTRINE COMPLIANCE GATE
# ═══════════════════════════════════════════════════════════════════════════════
# Authority: imo-creator (Constitutional)
# Purpose: Block commits that violate doctrine
# Install: ./scripts/install-hooks.sh
# ═══════════════════════════════════════════════════════════════════════════════

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

VIOLATIONS=0
WARNINGS=0

echo ""
echo "═══════════════════════════════════════════════════════════════"
echo "  DOCTRINE COMPLIANCE CHECK"
echo "═══════════════════════════════════════════════════════════════"
echo ""

# ───────────────────────────────────────────────────────────────────
# CHECK 1: Forbidden folders in src/
# ───────────────────────────────────────────────────────────────────
FORBIDDEN_FOLDERS=("utils" "helpers" "common" "shared" "lib" "misc")

if [ -d "src" ]; then
    for folder in "${FORBIDDEN_FOLDERS[@]}"; do
        if [ -d "src/$folder" ]; then
            echo -e "${RED}[VIOLATION]${NC} CTB_VIOLATION: src/$folder/ exists"
            echo "            Doctrine: No utils/helpers/common/shared/lib/misc folders"
            echo "            Action: Move contents to src/{sys,data,app,ai,ui} or DELETE"
            ((VIOLATIONS++))
        fi
    done
fi

# ───────────────────────────────────────────────────────────────────
# CHECK 2: Loose files in src/ root (if src exists)
# ───────────────────────────────────────────────────────────────────
if [ -d "src" ]; then
    LOOSE_FILES=$(find src -maxdepth 1 -type f 2>/dev/null | head -5)
    if [ -n "$LOOSE_FILES" ]; then
        echo -e "${RED}[VIOLATION]${NC} CTB_VIOLATION: Loose files in src/ root"
        echo "            Files found:"
        echo "$LOOSE_FILES" | while read -r f; do echo "              - $f"; done
        echo "            Action: Move to src/{sys,data,app,ai,ui} or DELETE"
        ((VIOLATIONS++))
    fi
fi

# ───────────────────────────────────────────────────────────────────
# CHECK 3: CTB folder structure (if src exists)
# ───────────────────────────────────────────────────────────────────
CTB_BRANCHES=("sys" "data" "app" "ai" "ui")

if [ -d "src" ]; then
    MISSING_BRANCHES=""
    for branch in "${CTB_BRANCHES[@]}"; do
        if [ ! -d "src/$branch" ]; then
            MISSING_BRANCHES="$MISSING_BRANCHES $branch"
        fi
    done

    if [ -n "$MISSING_BRANCHES" ]; then
        echo -e "${YELLOW}[WARNING]${NC} CTB structure incomplete"
        echo "          Missing branches:$MISSING_BRANCHES"
        echo "          Expected: src/{sys,data,app,ai,ui}"
        ((WARNINGS++))
    fi
fi

# ───────────────────────────────────────────────────────────────────
# CHECK 4: REGISTRY.yaml exists (for hub repos)
# ───────────────────────────────────────────────────────────────────
if [ -d "src" ] && [ ! -f "REGISTRY.yaml" ]; then
    echo -e "${YELLOW}[WARNING]${NC} REGISTRY.yaml missing"
    echo "          Hub repos require REGISTRY.yaml at root"
    echo "          See: REPO_REFACTOR_PROTOCOL.md section 3"
    ((WARNINGS++))
fi

# ───────────────────────────────────────────────────────────────────
# CHECK 5: DOCTRINE.md exists (for child repos)
# ───────────────────────────────────────────────────────────────────
# Skip this check if we're in imo-creator itself
REPO_NAME=$(basename "$(pwd)")
if [ "$REPO_NAME" != "imo-creator" ] && [ -d "src" ] && [ ! -f "DOCTRINE.md" ]; then
    echo -e "${YELLOW}[WARNING]${NC} DOCTRINE.md missing"
    echo "          Child repos must reference imo-creator doctrine"
    echo "          See: REPO_REFACTOR_PROTOCOL.md section 8"
    ((WARNINGS++))
fi

# ───────────────────────────────────────────────────────────────────
# CHECK 6: No secrets in staged files
# ───────────────────────────────────────────────────────────────────
STAGED_FILES=$(git diff --cached --name-only 2>/dev/null || true)
SECRET_PATTERNS=(".env" "credentials" "secret" "api_key" "apikey" "password")

for file in $STAGED_FILES; do
    for pattern in "${SECRET_PATTERNS[@]}"; do
        if echo "$file" | grep -qi "$pattern"; then
            echo -e "${RED}[VIOLATION]${NC} Potential secret file staged: $file"
            echo "            Action: Remove from staging or add to .gitignore"
            ((VIOLATIONS++))
        fi
    done
done

# ───────────────────────────────────────────────────────────────────
# CHECK 7: PRD exists before code changes (CC descent rule)
# ───────────────────────────────────────────────────────────────────
if [ -d "src" ]; then
    CODE_CHANGES=$(echo "$STAGED_FILES" | grep -E "^src/" | head -1 || true)
    if [ -n "$CODE_CHANGES" ] && [ ! -f "docs/PRD.md" ] && [ ! -f "PRD.md" ]; then
        echo -e "${YELLOW}[WARNING]${NC} Code changes without PRD"
        echo "          Descent rule: PRD (CC-02) before code (CC-04)"
        echo "          Action: Create docs/PRD.md first"
        ((WARNINGS++))
    fi
fi

# ───────────────────────────────────────────────────────────────────
# CHECK 8: Generated folder protection (Registry-First)
# ───────────────────────────────────────────────────────────────────
# If generated files are staged but column_registry.yml is NOT staged,
# someone hand-edited generated output — VIOLATION.
GENERATED_STAGED=$(echo "$STAGED_FILES" | grep -E "src/data/(spokes|hub)/.*/generated/" || true)
REGISTRY_STAGED=$(echo "$STAGED_FILES" | grep -E "column_registry\.yml$" || true)

if [ -n "$GENERATED_STAGED" ] && [ -z "$REGISTRY_STAGED" ]; then
    echo -e "${RED}[VIOLATION]${NC} CODEGEN_VIOLATION: Generated files modified without registry update"
    echo "            Files:"
    echo "$GENERATED_STAGED" | while read -r f; do echo "              - $f"; done
    echo "            Generated files are PROJECTIONS of column_registry.yml"
    echo "            Action: Update column_registry.yml, then run codegen-generate.sh"
    ((VIOLATIONS++))
fi

# ───────────────────────────────────────────────────────────────────
# CHECK 9: Codegen drift detection (Registry-First)
# ───────────────────────────────────────────────────────────────────
# If column_registry.yml is staged, verify generated files are in sync.
if [ -n "$REGISTRY_STAGED" ]; then
    CODEGEN_VERIFY=""
    if [ -f "scripts/codegen-verify.sh" ]; then
        CODEGEN_VERIFY="scripts/codegen-verify.sh"
    elif [ -f "./codegen-verify.sh" ]; then
        CODEGEN_VERIFY="./codegen-verify.sh"
    fi

    if [ -n "$CODEGEN_VERIFY" ]; then
        if ! bash "$CODEGEN_VERIFY" > /dev/null 2>&1; then
            echo -e "${RED}[VIOLATION]${NC} CODEGEN_DRIFT: Registry updated but generated files are out of sync"
            echo "            column_registry.yml was changed but generated output does not match"
            echo "            Action: Run codegen-generate.sh and stage the generated files"
            ((VIOLATIONS++))
        else
            echo -e "${GREEN}[PASS]${NC} Codegen sync verified — generated files match registry"
        fi
    else
        echo -e "${YELLOW}[WARNING]${NC} codegen-verify.sh not found — cannot verify registry sync"
        echo "          Install: Copy from imo-creator templates/scripts/"
        ((WARNINGS++))
    fi
fi

# ───────────────────────────────────────────────────────────────────
# CHECK 10: Manifest sync (templates/ changes)
# ───────────────────────────────────────────────────────────────────
# If any staged files are inside templates/, verify manifest is in sync.
TEMPLATE_STAGED=$(echo "$STAGED_FILES" | grep -E "^templates/" || true)

if [ -n "$TEMPLATE_STAGED" ]; then
    MANIFEST_VERIFY=""
    if [ -f "scripts/verify_manifest.sh" ]; then
        MANIFEST_VERIFY="scripts/verify_manifest.sh"
    elif [ -f "templates/scripts/verify_manifest.sh" ]; then
        MANIFEST_VERIFY="templates/scripts/verify_manifest.sh"
    fi

    if [ -n "$MANIFEST_VERIFY" ]; then
        if ! bash "$MANIFEST_VERIFY" > /dev/null 2>&1; then
            echo -e "${RED}[VIOLATION]${NC} MANIFEST_DRIFT: templates/ changed but manifest is out of sync"
            echo "            Staged template files do not match TEMPLATES_MANIFEST.yaml"
            echo "            Action: Run verify_manifest.sh and update TEMPLATES_MANIFEST.yaml"
            ((VIOLATIONS++))
        else
            echo -e "${GREEN}[PASS]${NC} Manifest sync verified — disk matches manifest"
        fi
    else
        echo -e "${YELLOW}[WARNING]${NC} verify_manifest.sh not found — cannot verify manifest sync"
        echo "          Install: Copy from imo-creator templates/scripts/"
        ((WARNINGS++))
    fi
fi

# ───────────────────────────────────────────────────────────────────
# CHECK 11: Doctrine checkpoint enforcement
# ───────────────────────────────────────────────────────────────────
# Only applies when staged files touch src/ (code changes).
# Docs-only or config-only changes skip this check silently.
SRC_STAGED=$(echo "$STAGED_FILES" | grep -E "^src/" | head -1 || true)

if [ -n "$SRC_STAGED" ]; then
    CHECKPOINT_FILE="DOCTRINE_CHECKPOINT.yaml"

    # 11a: Checkpoint file must exist
    if [ ! -f "$CHECKPOINT_FILE" ]; then
        echo -e "${RED}[VIOLATION]${NC} CHECKPOINT_MISSING: DOCTRINE_CHECKPOINT.yaml not found"
        echo "            Doctrine checkpoint required before coding."
        echo "            Action: Read CC_OPERATIONAL_DIGEST.md, fill out DOCTRINE_CHECKPOINT.yaml, then commit."
        ((VIOLATIONS++))
    else
        # 11b: Staleness check (24 hours)
        FILE_MOD=$(stat -c %Y "$CHECKPOINT_FILE" 2>/dev/null || stat -f %m "$CHECKPOINT_FILE" 2>/dev/null || echo "0")
        CURRENT=$(date +%s)
        AGE=$(( CURRENT - FILE_MOD ))
        MAX_AGE=86400  # 24 hours

        if [ "$AGE" -gt "$MAX_AGE" ]; then
            STALE_DATE=$(date -d "@$FILE_MOD" 2>/dev/null || date -r "$FILE_MOD" 2>/dev/null || echo "unknown")
            echo -e "${RED}[VIOLATION]${NC} CHECKPOINT_STALE: DOCTRINE_CHECKPOINT.yaml is older than 24 hours"
            echo "            Last modified: $STALE_DATE"
            echo "            Action: Re-read CC_OPERATIONAL_DIGEST.md and refresh the checkpoint"
            ((VIOLATIONS++))
        fi

        # 11c: All required fields must be filled (not empty, not bracket placeholders)
        CHECKPOINT_FIELDS=("last_verified" "verified_by" "digest_version" "ctb_branch_target" "hub_or_spoke" "logic_placement" "requires_adr" "registry_impact" "error_table_identified" "transformation")
        UNFILLED=""

        for field in "${CHECKPOINT_FIELDS[@]}"; do
            VALUE=$(grep -m1 "^[[:space:]]*${field}:" "$CHECKPOINT_FILE" | sed 's/^[^:]*:[[:space:]]*//' | sed 's/^"//' | sed 's/"$//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
            if [ -z "$VALUE" ] || echo "$VALUE" | grep -qE '^\[.*\]$'; then
                UNFILLED="$UNFILLED $field"
            fi
        done

        if [ -n "$UNFILLED" ]; then
            echo -e "${RED}[VIOLATION]${NC} CHECKPOINT_INCOMPLETE: Unfilled fields in DOCTRINE_CHECKPOINT.yaml"
            echo "            Missing/placeholder fields:$UNFILLED"
            echo "            Action: Fill ALL fields before committing code"
            ((VIOLATIONS++))
        fi

        # 11d: Spoke logic validation — spokes carry data only, no logic
        HUB_OR_SPOKE=$(grep -m1 "^[[:space:]]*hub_or_spoke:" "$CHECKPOINT_FILE" | sed 's/^[^:]*:[[:space:]]*//' | sed 's/^"//' | sed 's/"$//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
        LOGIC_PLACE=$(grep -m1 "^[[:space:]]*logic_placement:" "$CHECKPOINT_FILE" | sed 's/^[^:]*:[[:space:]]*//' | sed 's/^"//' | sed 's/"$//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')

        if [ "$HUB_OR_SPOKE" = "spoke" ]; then
            if [ -n "$LOGIC_PLACE" ] && [ "$LOGIC_PLACE" != "n/a" ] && ! echo "$LOGIC_PLACE" | grep -qE '^\[.*\]$'; then
                echo -e "${RED}[VIOLATION]${NC} HUB_SPOKE_VIOLATION: Spoke declared but logic_placement is not 'n/a'"
                echo "            Spokes carry data only — logic lives in hubs"
                echo "            logic_placement: '$LOGIC_PLACE'"
                echo "            Action: Set logic_placement to 'n/a' or change hub_or_spoke to 'hub'"
                ((VIOLATIONS++))
            fi
        fi
    fi
fi

# ───────────────────────────────────────────────────────────────────
# CHECK 12: Schema completeness enforcement (DBA Gate B)
# ───────────────────────────────────────────────────────────────────
# If column_registry.yml is staged, run validate-schema-completeness.sh
# to ensure all table and column metadata is complete (no placeholders).
if [ -n "$REGISTRY_STAGED" ]; then
    SCHEMA_VALIDATE=""
    if [ -f "scripts/validate-schema-completeness.sh" ]; then
        SCHEMA_VALIDATE="scripts/validate-schema-completeness.sh"
    elif [ -f "./validate-schema-completeness.sh" ]; then
        SCHEMA_VALIDATE="./validate-schema-completeness.sh"
    fi

    if [ -n "$SCHEMA_VALIDATE" ]; then
        if ! bash "$SCHEMA_VALIDATE" > /dev/null 2>&1; then
            echo -e "${RED}[VIOLATION]${NC} SCHEMA_INCOMPLETE: column_registry.yml has missing or placeholder metadata"
            echo "            DBA_ENFORCEMENT_DOCTRINE.md Gate B requires complete metadata"
            echo "            Every table: description + leaf_type + source_of_truth + row_identity_strategy"
            echo "            Every column: description + type + nullable + semantic_role + format"
            echo "            Action: Run validate-schema-completeness.sh, fix all violations, then commit"
            ((VIOLATIONS++))
        else
            echo -e "${GREEN}[PASS]${NC} Schema completeness verified — all metadata fields populated"
        fi
    else
        echo -e "${YELLOW}[WARNING]${NC} validate-schema-completeness.sh not found — cannot verify schema metadata"
        echo "          Install: Copy from imo-creator templates/scripts/"
        ((WARNINGS++))
    fi
fi

# ───────────────────────────────────────────────────────────────────
# SUMMARY
# ───────────────────────────────────────────────────────────────────
echo ""
echo "───────────────────────────────────────────────────────────────"

if [ $VIOLATIONS -gt 0 ]; then
    echo -e "${RED}BLOCKED${NC}: $VIOLATIONS violation(s) found"
    echo ""
    echo "Commit rejected. Fix violations before committing."
    echo "To bypass (not recommended): git commit --no-verify"
    echo ""
    exit 1
elif [ $WARNINGS -gt 0 ]; then
    echo -e "${YELLOW}PASSED WITH WARNINGS${NC}: $WARNINGS warning(s)"
    echo ""
    echo "Commit allowed. Address warnings when possible."
    echo ""
    exit 0
else
    echo -e "${GREEN}PASSED${NC}: Doctrine compliant"
    echo ""
    exit 0
fi
