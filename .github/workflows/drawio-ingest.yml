name: Draw.io + GitIngest Integration

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      include_diagrams:
        description: 'Include diagram generation'
        required: false
        default: 'true'
        type: boolean

jobs:
  drawio-ingest-analysis:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install gitingest
        pip install pyyaml requests

    - name: Generate GitIngest analysis
      run: |
        gitingest . -o repo-analysis.txt --include-pattern "*.py" --include-pattern "*.js" --include-pattern "*.md" --include-pattern "*.yml" --include-pattern "*.yaml" --include-pattern "*.json"
        echo "Repository analysis complete"

    - name: Create draw.io diagram templates
      run: |
        mkdir -p diagrams/generated
        python -c "
import json
import os

# Read GitIngest analysis
with open('repo-analysis.txt', 'r', encoding='utf-8') as f:
    analysis = f.read()

# Create architecture diagram metadata
diagram_data = {
    'repository': '${{ github.repository }}',
    'branch': '${{ github.ref_name }}',
    'timestamp': '${{ github.event.head_commit.timestamp }}',
    'analysis_tokens': len(analysis.split()),
    'diagram_templates': [
        {
            'name': 'Repository Architecture',
            'type': 'flowchart',
            'description': 'High-level repository structure and data flow',
            'suggested_elements': ['Input', 'Middle', 'Output', 'MCP Registry', 'Composio Integration']
        },
        {
            'name': 'MCP Tool Routing',
            'type': 'network',
            'description': 'Tool routing and fallback mechanisms',
            'suggested_elements': ['Composio Hub', 'Neon', 'Firebase', 'Apify', 'Fallback Tools']
        },
        {
            'name': 'CI/CD Workflow',
            'type': 'process',
            'description': 'GitHub Actions workflow visualization',
            'suggested_elements': ['Trigger', 'Build', 'Test', 'Deploy', 'Notify']
        },
        {
            'name': 'Doctrine Branches',
            'type': 'hierarchy',
            'description': 'Branch structure and auto-inclusion system',
            'suggested_elements': ['Master', 'Actions-Workflows', 'AI-Human-Readable', 'DrawIO-Ingest']
        }
    ]
}

with open('diagrams/generated/diagram-metadata.json', 'w') as f:
    json.dump(diagram_data, f, indent=2)
"

    - name: Generate draw.io XML templates
      run: |
        python -c "
import json

# Create basic draw.io XML template
drawio_template = '''<?xml version=\"1.0\" encoding=\"UTF-8\"?>
<mxfile host=\"app.diagrams.net\" modified=\"{timestamp}\" agent=\"IMO-Creator-GitIngest\" version=\"22.1.16\" etag=\"{etag}\" type=\"device\">
  <diagram name=\"Repository Architecture\" id=\"architecture\">
    <mxGraphModel dx=\"1422\" dy=\"794\" grid=\"1\" gridSize=\"10\" guides=\"1\" tooltips=\"1\" connect=\"1\" arrows=\"1\" fold=\"1\" page=\"1\" pageScale=\"1\" pageWidth=\"827\" pageHeight=\"1169\" math=\"0\" shadow=\"0\">
      <root>
        <mxCell id=\"0\" />
        <mxCell id=\"1\" parent=\"0\" />

        <!-- Input Layer -->
        <mxCell id=\"input\" value=\"Input Layer\\nData Validation &amp; Mapping\" style=\"rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;\" vertex=\"1\" parent=\"1\">
          <mxGeometry x=\"160\" y=\"120\" width=\"120\" height=\"60\" as=\"geometry\" />
        </mxCell>

        <!-- Middle Layer -->
        <mxCell id=\"middle\" value=\"Middle Layer\\nMCP Processing &amp; Routing\" style=\"rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;\" vertex=\"1\" parent=\"1\">
          <mxGeometry x=\"160\" y=\"240\" width=\"120\" height=\"60\" as=\"geometry\" />
        </mxCell>

        <!-- Output Layer -->
        <mxCell id=\"output\" value=\"Output Layer\\nNotification &amp; Reporting\" style=\"rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;\" vertex=\"1\" parent=\"1\">
          <mxGeometry x=\"160\" y=\"360\" width=\"120\" height=\"60\" as=\"geometry\" />
        </mxCell>

        <!-- Composio Hub -->
        <mxCell id=\"composio\" value=\"Composio MCP Hub\\n{composio_url}\" style=\"ellipse;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;\" vertex=\"1\" parent=\"1\">
          <mxGeometry x=\"400\" y=\"220\" width=\"140\" height=\"100\" as=\"geometry\" />
        </mxCell>

        <!-- Flow arrows -->
        <mxCell id=\"flow1\" style=\"edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;\" edge=\"1\" parent=\"1\" source=\"input\" target=\"middle\">
          <mxGeometry relative=\"1\" as=\"geometry\" />
        </mxCell>

        <mxCell id=\"flow2\" style=\"edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;\" edge=\"1\" parent=\"1\" source=\"middle\" target=\"output\">
          <mxGeometry relative=\"1\" as=\"geometry\" />
        </mxCell>

        <mxCell id=\"flow3\" style=\"edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;\" edge=\"1\" parent=\"1\" source=\"middle\" target=\"composio\">
          <mxGeometry relative=\"1\" as=\"geometry\" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>'''

import hashlib
import datetime

timestamp = datetime.datetime.now().isoformat()
etag = hashlib.md5(timestamp.encode()).hexdigest()[:8]
composio_url = 'https://composio-imo-creator-url.onrender.com'

template = drawio_template.format(
    timestamp=timestamp,
    etag=etag,
    composio_url=composio_url
)

with open('diagrams/generated/repository-architecture.drawio', 'w') as f:
    f.write(template)

print('Draw.io template created successfully')
"

    - name: Create diagram generation script
      run: |
        cat > generate_diagrams.py << 'EOF'
#!/usr/bin/env python3
\"\"\"
Generate draw.io diagrams based on GitIngest analysis
\"\"\"
import json
import os
import hashlib
from datetime import datetime

def create_mcp_routing_diagram():
    \"\"\"Create MCP tool routing diagram\"\"\"
    template = '''<?xml version="1.0" encoding="UTF-8"?>
<mxfile host="app.diagrams.net" modified="{timestamp}" agent="IMO-Creator-MCP-Generator" version="22.1.16">
  <diagram name="MCP Tool Routing" id="mcp-routing">
    <mxGraphModel dx="1422" dy="794" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- Central Composio Hub -->
        <mxCell id="hub" value="Composio MCP Hub\\n{composio_endpoint}" style="ellipse;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="350" y="250" width="160" height="100" as="geometry" />
        </mxCell>

        <!-- Primary MCP Tools -->
        <mxCell id="neon" value="Neon\\nPostgreSQL" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="150" y="150" width="100" height="60" as="geometry" />
        </mxCell>

        <mxCell id="firebase" value="Firebase\\nNoSQL" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="150" y="250" width="100" height="60" as="geometry" />
        </mxCell>

        <mxCell id="apify" value="Apify\\nWeb Scraping" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="150" y="350" width="100" height="60" as="geometry" />
        </mxCell>

        <mxCell id="builder" value="Builder.io\\nVisual Dev" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="150" y="450" width="100" height="60" as="geometry" />
        </mxCell>

        <!-- Fallback Tools -->
        <mxCell id="n8n" value="n8n\\nWorkflow" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="600" y="150" width="100" height="60" as="geometry" />
        </mxCell>

        <mxCell id="make" value="Make.com\\nAutomation" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="600" y="250" width="100" height="60" as="geometry" />
        </mxCell>

        <mxCell id="zapier" value="Zapier\\nIntegration" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="600" y="350" width="100" height="60" as="geometry" />
        </mxCell>

        <mxCell id="pipedream" value="Pipedream\\nWorkflow" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="600" y="450" width="100" height="60" as="geometry" />
        </mxCell>

        <!-- Connections to hub -->
        <mxCell style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#82b366;strokeWidth=2;" edge="1" parent="1" source="neon" target="hub" />
        <mxCell style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#82b366;strokeWidth=2;" edge="1" parent="1" source="firebase" target="hub" />
        <mxCell style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#82b366;strokeWidth=2;" edge="1" parent="1" source="apify" target="hub" />
        <mxCell style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#82b366;strokeWidth=2;" edge="1" parent="1" source="builder" target="hub" />

        <!-- Fallback connections -->
        <mxCell style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#d6b656;strokeWidth=1;dashed=1;" edge="1" parent="1" source="hub" target="n8n" />
        <mxCell style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#d6b656;strokeWidth=1;dashed=1;" edge="1" parent="1" source="hub" target="make" />
        <mxCell style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#d6b656;strokeWidth=1;dashed=1;" edge="1" parent="1" source="hub" target="zapier" />
        <mxCell style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#d6b656;strokeWidth=1;dashed=1;" edge="1" parent="1" source="hub" target="pipedream" />

        <!-- Legend -->
        <mxCell id="legend" value="Legend:\\n━━━ Primary MCP Tools\\n┉┉┉ Fallback Tools" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;align=left;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="50" width="150" height="60" as="geometry" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>'''

    timestamp = datetime.now().isoformat()
    composio_endpoint = "https://composio-imo-creator-url.onrender.com"

    diagram_content = template.format(
        timestamp=timestamp,
        composio_endpoint=composio_endpoint
    )

    with open('diagrams/generated/mcp-routing.drawio', 'w') as f:
        f.write(diagram_content)

    print("MCP routing diagram created")

def create_workflow_diagram():
    \"\"\"Create CI/CD workflow diagram\"\"\"
    template = '''<?xml version="1.0" encoding="UTF-8"?>
<mxfile host="app.diagrams.net" modified="{timestamp}" agent="IMO-Creator-Workflow-Generator" version="22.1.16">
  <diagram name="CI/CD Workflow" id="cicd-workflow">
    <mxGraphModel dx="1422" dy="794" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- Doctrine Branches -->
        <mxCell id="actions-branch" value="actions-workflows\\nBranch" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="100" y="120" width="120" height="60" as="geometry" />
        </mxCell>

        <mxCell id="ai-branch" value="ai-human-readable\\nBranch" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="100" y="220" width="120" height="60" as="geometry" />
        </mxCell>

        <mxCell id="drawio-branch" value="drawio-ingest\\nBranch" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="100" y="320" width="120" height="60" as="geometry" />
        </mxCell>

        <!-- Auto-scaffold process -->
        <mxCell id="scaffold" value="Auto-Scaffold\\nProcess" style="diamond;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="350" y="200" width="120" height="80" as="geometry" />
        </mxCell>

        <!-- New Repository -->
        <mxCell id="new-repo" value="New Repository\\nWith All Workflows" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="600" y="210" width="120" height="60" as="geometry" />
        </mxCell>

        <!-- Workflow types -->
        <mxCell id="compliance" value="✓ Compliance\\n✓ Tests\\n✓ Docs\\n✓ Deploy" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;" vertex="1" parent="1">
          <mxGeometry x="300" y="50" width="100" height="80" as="geometry" />
        </mxCell>

        <mxCell id="ai-readable" value="✓ GitIngest\\n✓ Diagrams\\n✓ Summaries" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;align=left;" vertex="1" parent="1">
          <mxGeometry x="420" y="50" width="100" height="80" as="geometry" />
        </mxCell>

        <mxCell id="visual" value="✓ Draw.io\\n✓ Architecture\\n✓ Visual Docs" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;" vertex="1" parent="1">
          <mxGeometry x="540" y="50" width="100" height="80" as="geometry" />
        </mxCell>

        <!-- Flow arrows -->
        <mxCell style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="actions-branch" target="scaffold" />
        <mxCell style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="ai-branch" target="scaffold" />
        <mxCell style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="drawio-branch" target="scaffold" />
        <mxCell style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="scaffold" target="new-repo" />

        <!-- Capability arrows -->
        <mxCell style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="compliance" target="scaffold" />
        <mxCell style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="ai-readable" target="scaffold" />
        <mxCell style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="visual" target="scaffold" />

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>'''

    timestamp = datetime.now().isoformat()

    diagram_content = template.format(timestamp=timestamp)

    with open('diagrams/generated/cicd-workflow.drawio', 'w') as f:
        f.write(diagram_content)

    print("CI/CD workflow diagram created")

if __name__ == "__main__":
    os.makedirs('diagrams/generated', exist_ok=True)
    create_mcp_routing_diagram()
    create_workflow_diagram()
    print("All diagrams generated successfully!")
EOF
        chmod +x generate_diagrams.py
        python generate_diagrams.py

    - name: Generate README for diagrams
      run: |
        cat > diagrams/README.md << 'EOF'
# IMO-Creator Diagrams

This directory contains automatically generated draw.io diagrams based on GitIngest repository analysis.

## Generated Diagrams

### Repository Architecture (`repository-architecture.drawio`)
- High-level view of Input→Middle→Output architecture
- Shows relationship between layers and Composio MCP hub
- Generated from GitIngest analysis

### MCP Tool Routing (`mcp-routing.drawio`)
- Visual representation of MCP tool connections
- Primary tools: Neon, Firebase, Apify, Builder.io
- Fallback tools: n8n, Make.com, Zapier, Pipedream
- Central Composio hub routing

### CI/CD Workflow (`cicd-workflow.drawio`)
- Doctrine branch auto-scaffolding process
- Shows how workflows are inherited by new repositories
- Includes compliance, AI-readable, and visual documentation workflows

## Usage

1. **View in VS Code**: Install the Draw.io Integration extension
2. **Edit Online**: Upload `.drawio` files to https://app.diagrams.net
3. **Export**: Generate PNG/SVG exports for documentation

## Auto-Generation

These diagrams are automatically updated by the `drawio-ingest.yml` GitHub Action whenever:
- Code is pushed to main/master branches
- Pull requests are created
- Manual workflow dispatch is triggered

The diagrams reflect the current repository structure as analyzed by GitIngest.
EOF

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: drawio-diagrams
        path: |
          diagrams/
          repo-analysis.txt
        retention-days: 30

    - name: Commit generated diagrams
      if: github.event_name == 'push'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        if [ -n "$(git status --porcelain)" ]; then
          git add diagrams/
          git commit -m "🎨 Auto-generate draw.io diagrams from GitIngest analysis

          - Repository architecture diagram
          - MCP tool routing visualization
          - CI/CD workflow mapping
          - Generated from commit ${{ github.sha }}

          🤖 Generated by drawio-ingest workflow"

          # Only push if this is not a pull request
          if [ "${{ github.event_name }}" = "push" ]; then
            git push
          fi
        else
          echo "No changes to commit"
        fi